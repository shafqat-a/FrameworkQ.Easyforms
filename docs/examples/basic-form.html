<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>HTMLDSL Example - Basic Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    /* Example-only styles for clarity; production should use enterprise CSS */
    body { padding: 20px; }
    [data-page] { margin-bottom: 24px; }
    [data-section] { margin-bottom: 16px; }
    table[data-table] th, table[data-table] td { vertical-align: middle; }
  </style>
  <!-- In production, link to a real runtime: /js/formruntime-htmldsl.js -->
</head>
<body>
  <form data-form="demo-log" data-title="Demo Log Sheet" data-version="1.0">
    <section data-page id="page-1" data-title="Page 1">
      <section data-section id="header" data-title="Header">
        <table class="table table-bordered table-sm" data-widget="formheader">
          <tr>
            <td class="bg-light"><strong>Quality Management System</strong></td>
            <td colspan="3" class="text-center"><strong>MY ORGANIZATION</strong></td>
            <td class="bg-light"><strong>QUALITY FORMS</strong></td>
          </tr>
          <tr>
            <td><strong>Document No:</strong></td>
            <td><input name="document_no" class="form-control form-control-sm"></td>
            <td><strong>Revision No.:</strong></td>
            <td><input name="revision_no" class="form-control form-control-sm"></td>
            <td rowspan="2" class="text-center align-middle"><strong>Page:</strong><br>1 of 1</td>
          </tr>
          <tr>
            <td colspan="2" class="text-center"><strong>TITLE: Demo Log Sheet</strong></td>
            <td><strong>Effective Date:</strong></td>
            <td><input type="date" name="effective_date" class="form-control form-control-sm"></td>
          </tr>
        </table>
      </section>

      <section data-section id="main" data-title="Main">
        <div class="mb-3">
          <label for="meter_reading" class="form-label">Meter Reading</label>
          <input id="meter_reading" name="meter_reading" type="number" min="0" step="1" class="form-control"
                 data-type="integer" data-required>
        </div>

        <table class="table table-bordered" data-table id="measurements" data-row-mode="infinite" data-allow-add-rows>
          <thead>
            <tr>
              <th data-col="timestamp" data-type="datetime" data-label="Time"></th>
              <th data-col="voltage_kv" data-type="decimal" data-label="Voltage (kV)"></th>
              <th data-col="current_a" data-type="decimal" data-label="Current (A)"></th>
              <th data-col="power_mw" data-type="decimal" data-label="Power (MW)"
                  data-formula="voltage_kv * current_a / 1000"></th>
            </tr>
          </thead>
          <tbody>
            <tr data-row-template>
              <td><input name="timestamp" type="datetime-local" class="form-control"></td>
              <td><input name="voltage_kv" type="number" step="0.01" class="form-control"></td>
              <td><input name="current_a" type="number" step="0.01" class="form-control"></td>
              <td><input name="power_mw" type="number" step="0.001" class="form-control" data-computed></td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" class="text-end">Total Energy (MkWh)</td>
              <td data-agg="sum(power_mw)" data-target="#total_energy"></td>
            </tr>
          </tfoot>
        </table>

        <div class="mb-3">
          <label for="total_energy" class="form-label">Total Energy</label>
          <input id="total_energy" name="total_energy" type="number" class="form-control" data-readonly>
        </div>
      </section>

      <section data-section id="approval" data-title="Approval">
        <div data-widget="signature" data-role="Reviewed by" data-show-date="true">
          <div class="row g-2">
            <div class="col-md-4">
              <label for="sig_name" class="form-label">Name</label>
              <input id="sig_name" name="sig_name" class="form-control" data-required>
            </div>
            <div class="col-md-4">
              <label for="sig_desig" class="form-label">Designation</label>
              <input id="sig_desig" name="sig_desig" class="form-control">
            </div>
            <div class="col-md-4">
              <label for="sig_date" class="form-label">Date</label>
              <input id="sig_date" name="sig_date" type="date" class="form-control">
            </div>
          </div>
        </div>
      </section>
    </section>

    <div class="mt-3 d-print-none">
      <button type="button" class="btn btn-secondary" onclick="window.print()">Print</button>
      <button type="submit" class="btn btn-primary">Submit</button>
    </div>
  </form>

  <script>
    // Minimal demo behaviors (placeholder). A production runtime would be a separate module.
    (function() {
      const form = document.querySelector('form[data-form]');
      if (!form) return;

      // Simple computed fields in table rows
      form.addEventListener('input', (e) => {
        const row = e.target.closest('tr');
        if (row && row.querySelector('[name="voltage_kv"], [name="current_a"]')) {
          const v = parseFloat((row.querySelector('[name="voltage_kv"]')?.value || '0'));
          const a = parseFloat((row.querySelector('[name="current_a"]')?.value || '0'));
          const out = row.querySelector('[name="power_mw"][data-computed]');
          if (out) out.value = ((v * a) / 1000).toFixed(3);
        }
        aggregate();
      });

      // Add row on demand (rudimentary)
      form.querySelectorAll('table[data-table]').forEach(tbl => {
        const template = tbl.querySelector('tr[data-row-template]');
        if (!template) return;
        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'btn btn-sm btn-outline-primary d-print-none';
        addBtn.textContent = 'Add Row';
        addBtn.addEventListener('click', () => {
          const clone = template.cloneNode(true);
          clone.removeAttribute('data-row-template');
          clone.querySelectorAll('input,select,textarea').forEach(x => x.value = '');
          template.parentElement.appendChild(clone);
        });
        tbl.parentElement.insertBefore(addBtn, tbl.nextSibling);
      });

      function aggregate() {
        document.querySelectorAll('[data-agg]').forEach(cell => {
          const agg = cell.getAttribute('data-agg') || '';
          const m = agg.match(/^(sum|avg|min|max|count)\(([^)]*)\)$/i);
          let result = '';
          if (m) {
            const fn = m[1].toLowerCase();
            const col = m[2].trim();
            const values = Array.from(document.querySelectorAll(`[name="${col}"]`))
              .map(i => parseFloat(i.value))
              .filter(v => !isNaN(v));
            if (fn === 'sum') result = values.reduce((a,b)=>a+b,0);
            else if (fn === 'avg') result = values.length ? values.reduce((a,b)=>a+b,0)/values.length : 0;
            else if (fn === 'min') result = values.length ? Math.min(...values) : '';
            else if (fn === 'max') result = values.length ? Math.max(...values) : '';
            else if (fn === 'count') result = values.length;
          }
          const targetSel = cell.getAttribute('data-target');
          if (targetSel) {
            const t = document.querySelector(targetSel);
            if (t) t.value = typeof result === 'number' ? Number(result.toFixed(3)) : result;
          } else {
            cell.textContent = result;
          }
        });
      }

      // Initial aggregate
      aggregate();

      // Submit handler (serialize demo)
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(form).entries());
        console.log('Serialized (demo):', data);
        alert('Demo submit: check console for serialized data');
      });
    })();
  </script>
</body>
</html>

